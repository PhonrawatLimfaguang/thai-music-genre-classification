# -*- coding: utf-8 -*-
"""Model_HTML_Test_5_4_68.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1wcznieH6H3e4_us9ibqcIF2JciRJTvT5

<h1>‡∏ß‡∏¥‡∏ò‡∏µ Test
‡πÉ‡∏´‡πâ‡∏ß‡∏≤‡∏á‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÉ‡∏ô‡πÑ‡∏î‡∏£‡πå‡∏ü‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á

<h1>‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏û‡∏•‡∏á‡πÉ‡∏™‡πà‡πÄ‡∏û‡∏•‡∏ámp3‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ

<h1>‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏û‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô.wav

<h1>‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡πá‡∏•‡∏≠‡∏á‡πÄ‡∏•‡∏¢‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡∏•‡∏∞‡πÄ‡∏û‡∏•‡∏á‡∏ô‡∏∞

<h1>‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÑ‡∏î‡∏£‡πå‡∏ü‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á
"""

from google.colab import drive
drive.mount('/content/drive/')

"""<h1>‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏û‡∏•‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÉ‡∏´‡πâtest‡πÄ‡∏õ‡πá‡∏ô.wav

<h1>import
"""

!apt-get install ffmpeg -y
!pip install pydub
from pydub import AudioSegment
from pydub.utils import which

AudioSegment.converter = which("ffmpeg")  # ‡∏ö‡∏≠‡∏Å‡πÉ‡∏´‡πâ pydub ‡πÉ‡∏ä‡πâ ffmpeg

from pydub import AudioSegment
import os

# ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡πà‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå .mp3 ‡πÄ‡∏õ‡πá‡∏ô .wav
def convert_mp3_to_wav(mp3_path, wav_path):
    audio = AudioSegment.from_mp3(mp3_path)
    audio = audio.set_frame_rate(22050).set_channels(1)  # ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Sample Rate ‡πÅ‡∏•‡∏∞ Mono
    audio.export(wav_path, format="wav")
    print(f"‚úÖ ‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå {mp3_path} ‡πÄ‡∏õ‡πá‡∏ô {wav_path} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!")

# ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡πÑ‡∏ü‡∏•‡πå
mp3_folder = "/content/drive/My Drive/Project DE242 Music Genre Classification/Unseen_Data"  # ‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ü‡∏•‡πå .mp3
output_folder = "/content/drive/My Drive/Project DE242 Music Genre Classification/Unseen_Data_WAV"  # ‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ü‡∏•‡πå .wav

# ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå .wav ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
os.makedirs(output_folder, exist_ok=True)

# ‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå .mp3 ‡πÄ‡∏õ‡πá‡∏ô .wav
for file in os.listdir(mp3_folder):
    if file.endswith(".mp3"):
        mp3_path = os.path.join(mp3_folder, file)
        wav_path = os.path.join(output_folder, file.replace(".mp3", ".wav"))
        convert_mp3_to_wav(mp3_path, wav_path)

print("‚úÖ ‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô!")

"""<h1>‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏´‡πá‡∏ô‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô (Unseen Data)"""

import librosa
import numpy as np
import joblib  # ‡πÉ‡∏ä‡πâ joblib ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ó‡∏µ‡πà‡∏ù‡∏∂‡∏Å‡πÑ‡∏ß‡πâ
import os

# ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏ó‡∏£‡∏ô‡πÑ‡∏ß‡πâ (Random Forest)
model = joblib.load("/content/drive/My Drive/Project DE242 Music Genre Classification/random_forest_model.pkl")

# ‡∏Å‡∏≥‡∏´‡∏ô‡∏î label ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ô‡∏ß‡πÄ‡∏û‡∏•‡∏á
genres = ["Northern song", "Northeastern song", "Southern song", "Central song"]

# ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á
def extract_features(file_path):
    y, sr = librosa.load(file_path, sr=22050)

    # ‡∏î‡∏∂‡∏á MFCC, Chroma, Spectral Contrast
    mfcc = librosa.feature.mfcc(y=y, sr=sr, n_mfcc=13).mean(axis=1)
    chroma = librosa.feature.chroma_stft(y=y, sr=sr).mean(axis=1)
    spectral_contrast = librosa.feature.spectral_contrast(y=y, sr=sr).mean(axis=1)

    # ‡∏£‡∏ß‡∏°‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    features = np.hstack([mfcc, chroma, spectral_contrast])
    return features

# üìÇ ‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏û‡∏•‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö (Unseen Data)
test_folder = "/content/drive/My Drive/Project DE242 Music Genre Classification/Unseen_Data_WAV"

# ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå
for file in os.listdir(test_folder):
    if file.endswith(".wav"):
        file_path = os.path.join(test_folder, file)

        # ‡∏î‡∏∂‡∏á‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå
        features = extract_features(file_path)
        features = features.reshape(1, -1)  # Reshape ‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö‡πÇ‡∏°‡πÄ‡∏î‡∏•

# ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå‡πÅ‡∏ô‡∏ß‡πÄ‡∏û‡∏•‡∏á
prediction = model.predict(features)

# Access the predicted label directly
predicted_label = prediction[0]

print(f"üéµ ‡πÑ‡∏ü‡∏•‡πå: {file} ‚Üí ‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ô‡∏ß‡πÄ‡∏û‡∏•‡∏á: {predicted_label}")

"""<h1>‡πÄ‡∏ß‡πá‡∏õHTML"""

# ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏•‡∏ö‡∏£‡∏≤‡∏£‡∏µ‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
!pip install flask flask-cors pyngrok pydub librosa scikit-learn

# ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ä‡πâ pyngrok ‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡πÅ‡∏ó‡∏ô flask_ngrok
from pyngrok import ngrok

# ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á ngrok ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ Flask
!pip install pyngrok
!ngrok authtoken YOUR_AUTH_TOKEN  # ‡∏£‡∏±‡∏ö token ‡∏à‡∏≤‡∏Å https://dashboard.ngrok.com/get-started/your-authtoken

!apt install ffmpeg

from flask import Flask, request, jsonify
from flask_cors import CORS
import os
import numpy as np
import librosa
import joblib
from pydub import AudioSegment
from pydub.utils import which

# ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Ngrok
ngrok.set_auth_token("2vDIG7SNYtNCgxajjckTsNcV2td_3m79MR3Hp7neCpkK7tTKZ")  # ‡πÉ‡∏™‡πà Auth Token ‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
public_url = ngrok.connect(5000).public_url
AudioSegment.converter = which("ffmpeg")

app = Flask(__name__)
CORS(app)

# ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
model_path = "/content/drive/My Drive/Project DE242 Music Genre Classification/random_forest_model.pkl"
model = joblib.load(model_path)
print(f"‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏à‡∏≤‡∏Å: {model_path}")

# ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ô‡∏ß‡πÄ‡∏û‡∏•‡∏á
genres = ["Northern song", "Northeastern song", "Southern song", "Central song"]

# ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á
def extract_features(file_path):
    y, sr = librosa.load(file_path, sr=22050)
    mfcc = librosa.feature.mfcc(y=y, sr=sr, n_mfcc=13).mean(axis=1)
    chroma = librosa.feature.chroma_stft(y=y, sr=sr).mean(axis=1)
    spectral_contrast = librosa.feature.spectral_contrast(y=y, sr=sr).mean(axis=1)
    return np.hstack([mfcc, chroma, spectral_contrast])

@app.route("/predict", methods=["POST"])
def predict():
    try:
        file = request.files["file"]
        temp_path = f"/tmp/{file.filename}"
        file.save(temp_path)

        # ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô .wav ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô mp3
        if file.filename.endswith(".mp3"):
            wav_path = temp_path.replace(".mp3", ".wav")
            audio = AudioSegment.from_mp3(temp_path)
            audio = audio.set_frame_rate(22050).set_channels(1)
            audio.export(wav_path, format="wav")
            os.remove(temp_path)
            temp_path = wav_path

        features = extract_features(temp_path)
        features = features.reshape(1, -1)

        prediction = model.predict(features)
        predicted_genre = prediction[0]


        os.remove(temp_path)

        return jsonify({'genre': predicted_genre, 'status': 'success'})

    except Exception as e:
        print("üî• Error:", str(e))
        return jsonify({'error': str(e)}), 500

# pyngrok tunnel
from pyngrok import ngrok
public_url = ngrok.connect(5000)
print("üåê Public URL:", public_url)

app.run()